<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#F2F2F7">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Garden">
<title>Garden</title>
<link rel="manifest" id="manifest-link" href="#">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{height:100%;-webkit-text-size-adjust:100%;}
body{font-family:'Plus Jakarta Sans',-apple-system,sans-serif;height:100%;overflow:hidden;background:#F2F2F7;color:#1C1C1E;-webkit-font-smoothing:antialiased;}
:root{
  --green:#34C759;--green-dark:#248A3D;--green-soft:rgba(52,199,89,0.12);
  --blue:#007AFF;--orange:#FF9500;--red:#FF3B30;
  --label:#1C1C1E;--label2:#3C3C43CC;--label3:#3C3C4399;--label4:#3C3C432E;
  --bg:#F2F2F7;--bg2:#FFFFFF;--bg3:#F2F2F7;
  --fill:#78788033;--fill2:#78788028;--separator:rgba(60,60,67,0.12);
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06),0 1px 2px rgba(0,0,0,0.04);
  --shadow-md:0 4px 16px rgba(0,0,0,0.08),0 1px 4px rgba(0,0,0,0.04);
  --shadow-lg:0 16px 48px rgba(0,0,0,0.18),0 4px 16px rgba(0,0,0,0.10);
  --radius-sm:10px;--radius:16px;--radius-lg:22px;
  --tab-h:83px;--nav-h:56px;
  --sidebar-w:260px;
  --spring:cubic-bezier(0.34,1.56,0.64,1);--ease-out:cubic-bezier(0.4,0,0.2,1);
}

/* â•â•â• LAYOUT BASE (mobile) â•â•â• */
#app{position:fixed;inset:0;display:flex;flex-direction:column;overflow:hidden;background:var(â€“bg);}
.nav-bar{height:calc(var(â€“nav-h) + env(safe-area-inset-top,0px));padding-top:env(safe-area-inset-top,0px);background:rgba(242,242,247,0.85);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:0.5px solid var(â€“separator);display:flex;align-items:center;padding-left:8px;padding-right:8px;position:relative;z-index:50;flex-shrink:0;}
.nav-title{font-size:17px;font-weight:600;letter-spacing:-0.4px;color:var(â€“label);position:absolute;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .2s ease;white-space:nowrap;}
.nav-title.visible{opacity:1;}
.nav-left,.nav-right{display:flex;gap:4px;align-items:center;}
.nav-right{margin-left:auto;}
.nav-btn{width:36px;height:36px;background:var(â€“fill);border:none;border-radius:50%;color:var(â€“blue);font-size:17px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .15s var(â€“spring),background .15s ease;}
.nav-btn:active{transform:scale(0.88);}
.nav-btn.green{color:var(â€“green-dark);}
.nav-btn.gray{color:var(â€“label3);}

/* MAIN BODY (mobile: column) */
.app-body{flex:1;display:flex;overflow:hidden;}
.scroll-area{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;padding-bottom:var(â€“tab-h);}
.scroll-area::-webkit-scrollbar{display:none;}

.section{display:none;}
.section.active{display:block;animation:sIn .28s var(â€“ease-out);}
@keyframes sIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

.large-title-wrap{padding:8px 20px 12px;}
.large-title{font-size:34px;font-weight:800;letter-spacing:-1px;color:var(â€“label);line-height:1.1;}
.large-title span{color:var(â€“green);}
.large-subtitle{font-size:15px;color:var(â€“label3);font-weight:400;margin-top:4px;}

/* TAB BAR (mobile bottom) */
.tab-bar{height:var(â€“tab-h);padding-bottom:env(safe-area-inset-bottom,16px);background:rgba(249,249,249,.88);backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);border-top:.5px solid var(â€“separator);display:flex;align-items:flex-start;padding-top:8px;flex-shrink:0;z-index:50;}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;border:none;background:none;cursor:pointer;transition:transform .15s var(â€“spring);padding:0 2px;}
.tab-item:active{transform:scale(0.88);}
.tab-icon{font-size:23px;filter:grayscale(1) opacity(.5);transition:filter .15s ease,transform .2s var(â€“spring);}
.tab-item.active .tab-icon{filter:none;transform:scale(1.08);}
.tab-label{font-size:10px;font-weight:500;color:var(â€“label3);transition:color .15s ease;white-space:nowrap;}
.tab-item.active .tab-label{color:var(â€“green-dark);font-weight:700;}

/* SIDEBAR (hidden on mobile) */
.sidebar{display:none;}

/* FAB */
.fab{position:fixed;bottom:calc(var(â€“tab-h) + 16px);right:16px;width:56px;height:56px;background:var(â€“green);border:none;border-radius:50%;box-shadow:0 4px 20px rgba(52,199,89,.45);color:white;font-size:28px;font-weight:300;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:200;transition:transform .2s var(â€“spring);}
.fab:active{transform:scale(0.88);}

/* â•â•â• RESPONSIVE: iPad / Desktop (â‰¥768px) â•â•â• */
@media (min-width: 768px) {
body{overflow:hidden;}

#app{
position:fixed;inset:0;
flex-direction:column;
max-width:none;
margin:0;
}

/* Top nav bar: sits above sidebar+content */
.nav-bar{
width:100%;
padding-left:24px;
padding-right:24px;
background:rgba(242,242,247,0.95);
backdrop-filter:blur(20px);
z-index:100;
border-bottom:.5px solid var(â€“separator);
}

.nav-title{
position:relative;
left:auto;
transform:none;
opacity:1 !important;
font-size:18px;
font-weight:700;
letter-spacing:-.4px;
}

/* Hide mobile tab bar */
.tab-bar{display:none;}

/* Show sidebar */
.sidebar{
display:flex;
flex-direction:column;
width:var(â€“sidebar-w);
flex-shrink:0;
background:rgba(248,248,248,0.95);
backdrop-filter:blur(20px);
-webkit-backdrop-filter:blur(20px);
border-right:.5px solid var(â€“separator);
padding-top:16px;
padding-bottom:env(safe-area-inset-bottom,16px);
overflow-y:auto;
z-index:50;
}

.sidebar-logo{
display:flex;align-items:center;gap:10px;
padding:0 20px 20px;
border-bottom:.5px solid var(â€“separator);
margin-bottom:8px;
}
.sidebar-logo-icon{
width:36px;height:36px;border-radius:10px;
background:linear-gradient(145deg,#2ECC71,#27AE60);
display:flex;align-items:center;justify-content:center;font-size:20px;
box-shadow:0 4px 12px rgba(52,199,89,.3);
}
.sidebar-logo-name{font-size:18px;font-weight:800;letter-spacing:-.5px;color:var(â€“label);}

.sidebar-nav{flex:1;padding:4px 12px;}
.sidebar-item{
display:flex;align-items:center;gap:12px;
padding:11px 14px;border-radius:12px;
border:none;background:none;cursor:pointer;
width:100%;text-align:left;
transition:background .15s ease;
margin-bottom:2px;
}
.sidebar-item:hover{background:var(â€“fill2);}
.sidebar-item.active{background:var(â€“green-soft);}
.sidebar-item .si-icon{font-size:20px;width:28px;text-align:center;filter:grayscale(1) opacity(.5);transition:filter .15s ease;}
.sidebar-item.active .si-icon{filter:none;}
.sidebar-item .si-label{font-size:15px;font-weight:500;color:var(â€“label3);transition:color .15s ease;}
.sidebar-item.active .si-label{color:var(â€“green-dark);font-weight:700;}

.sidebar-footer{
padding:12px 16px;
border-top:.5px solid var(â€“separator);
}
.sidebar-settings{
display:flex;align-items:center;gap:10px;
padding:10px 14px;border-radius:12px;
border:none;background:none;cursor:pointer;width:100%;
transition:background .15s ease;
}
.sidebar-settings:hover{background:var(â€“fill2);}
.sidebar-settings span{font-size:14px;font-weight:500;color:var(â€“label3);}

/* App body: sidebar + content side by side */
.app-body{
flex:1;
display:flex;
overflow:hidden;
min-height:0;
}

/* Main content area â€” full width after sidebar, NO max-width cap */
.scroll-area{
flex:1;
padding-bottom:32px;
background:var(â€“bg);
min-width:0;
}

/* FAB: bigger and more visible */
.fab{
bottom:32px;
right:32px;
width:64px;
height:64px;
font-size:32px;
box-shadow:0 6px 24px rgba(52,199,89,.55);
}

/* Hide settings btn from nav (itâ€™s in sidebar footer) */
.nav-btn.gray#btn-settings{display:none;}

/* Large title bigger on iPad */
.large-title{font-size:38px;}
.large-title-wrap{padding:16px 24px 16px;}

/* Stat row: fix so all 3 fit, no overflow */
.stat-row{
grid-template-columns:repeat(3,1fr);
margin:0 24px 20px;
gap:12px;
}
.stat-num{font-size:24px;}

/* Seasonal banner */
.seasonal-banner{margin:0 24px 20px;}

/* Detail panel: slide from right as panel, not fullscreen */
.detail-view{
width:min(500px, 50vw);
left:auto;
right:0;
border-left:.5px solid var(â€“separator);
box-shadow:-8px 0 32px rgba(0,0,0,0.08);
}

/* Sheets centered on iPad */
.sheet-overlay{max-width:none;}
.sheet{
max-width:600px;
margin:0 auto;
border-radius:20px 20px 0 0;
}

/* Month strip / seg */
.month-strip{padding:4px 24px 12px;}
.seg-wrap{padding:0 24px 10px;}
#calendario-list{padding:0 24px;}
.cal-card-wrap{margin:0 0 10px;}
}

/* â•â•â• COMPONENTS (shared) â•â•â• */
.list-card{background:var(â€“bg2);border-radius:var(â€“radius);overflow:hidden;box-shadow:var(â€“shadow-sm);}
.list-row{display:flex;align-items:center;padding:13px 16px;gap:12px;cursor:pointer;transition:background .12s ease;position:relative;min-height:52px;}
.list-row:not(:last-child)::after{content:â€™â€™;position:absolute;left:56px;right:0;bottom:0;height:.5px;background:var(â€“separator);}
.list-row:active{background:var(â€“fill2);}

.plant-card{background:var(â€“bg2);border-radius:var(â€“radius-lg);padding:16px;box-shadow:var(â€“shadow-sm);cursor:pointer;transition:transform .18s var(â€“spring),box-shadow .18s ease;margin:0 16px 12px;position:relative;overflow:hidden;}
.plant-card::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(â€“green),#5AC8FA);}
.plant-card:active{transform:scale(0.975);box-shadow:none;}
.plant-card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
.plant-names{flex:1;min-width:0;}
.plant-name{font-size:18px;font-weight:700;letter-spacing:-0.5px;color:var(â€“label);line-height:1.2;}
.plant-sci{font-size:13px;color:var(â€“label3);margin-top:2px;font-style:italic;}
.plant-card-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.plant-type-pill{font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;background:var(â€“green-soft);color:var(â€“green-dark);}
.plant-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.meta-chip{font-size:12px;font-weight:500;padding:4px 10px;border-radius:20px;background:var(â€“bg3);color:var(â€“label2);}
.plant-desc{font-size:14px;color:var(â€“label2);line-height:1.5;margin-top:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.plant-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;}
.icon-btn{width:34px;height:34px;background:var(â€“fill);border:none;border-radius:50%;color:var(â€“label2);font-size:15px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .15s var(â€“spring);}
.icon-btn:active{transform:scale(0.85);}

.health-ring{width:44px;height:44px;flex-shrink:0;position:relative;}
.health-ring svg{transform:rotate(-90deg);}
.health-ring .ring-bg{fill:none;stroke:#E5E5EA;stroke-width:3.5;}
.health-ring .ring-fg{fill:none;stroke-width:3.5;stroke-linecap:round;}
.health-score-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;}

.seasonal-banner{margin:0 16px 16px;background:linear-gradient(135deg,#1C3A1F,#2D5A32);border-radius:var(â€“radius-lg);padding:16px;position:relative;overflow:hidden;}
.seasonal-banner::after{content:â€˜ğŸŒ¿â€™;position:absolute;right:-8px;top:-8px;font-size:72px;opacity:.1;pointer-events:none;}
.sb-label{font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.5);margin-bottom:6px;}
.sb-title{font-size:18px;font-weight:800;letter-spacing:-.5px;color:white;}
.sb-tips{margin-top:10px;display:flex;flex-direction:column;gap:6px;}
.sb-tip{display:flex;align-items:flex-start;gap:8px;font-size:13px;color:rgba(255,255,255,.85);line-height:1.4;}
.sb-tip-dot{width:6px;height:6px;border-radius:50%;background:var(â€“green);flex-shrink:0;margin-top:5px;}

.journal-card{background:var(â€“bg2);border-radius:var(â€“radius-lg);padding:14px 16px;box-shadow:var(â€“shadow-sm);cursor:pointer;transition:transform .15s var(â€“spring);margin:0 16px 10px;}
.journal-card:active{transform:scale(0.975);}
.jc-top{display:flex;align-items:center;justify-content:space-between;}
.jc-icon{width:36px;height:36px;border-radius:10px;background:var(â€“green-soft);color:var(â€“green-dark);display:flex;align-items:center;justify-content:center;font-size:18px;}
.jc-activity{font-size:16px;font-weight:600;letter-spacing:-.3px;color:var(â€“label);}
.jc-date{font-size:12px;color:var(â€“label3);font-weight:500;}

.k-card{background:var(â€“bg2);border-radius:var(â€“radius);padding:14px 16px;box-shadow:var(â€“shadow-sm);cursor:pointer;margin:0 16px 10px;transition:transform .15s var(â€“spring);}
.k-card:active{transform:scale(0.975);}
.k-topic{font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(â€“blue);margin-bottom:4px;}
.k-title{font-size:16px;font-weight:600;letter-spacing:-.3px;color:var(â€“label);line-height:1.3;}
.k-source{font-size:13px;color:var(â€“label3);margin-top:3px;}

.month-strip{display:flex;overflow-x:auto;gap:6px;padding:4px 16px 12px;scrollbar-width:none;}
.month-strip::-webkit-scrollbar{display:none;}
.month-pill{flex-shrink:0;font-size:14px;font-weight:600;padding:7px 16px;border-radius:20px;border:none;cursor:pointer;background:var(â€“fill);color:var(â€“label2);transition:background .15s ease,color .15s ease,transform .15s var(â€“spring);}
.month-pill.active{background:var(â€“green);color:white;}
.month-pill:active{transform:scale(0.92);}

.seg-wrap{padding:0 16px 10px;}
.seg-ctrl{display:flex;background:var(â€“fill);border-radius:10px;padding:2px;}
.seg-btn{flex:1;padding:6px 4px;border:none;border-radius:8px;font-size:13px;font-weight:600;color:var(â€“label2);background:transparent;cursor:pointer;transition:background .2s ease,color .2s ease,box-shadow .2s ease;}
.seg-btn.active{background:var(â€“bg2);color:var(â€“label);box-shadow:0 2px 8px rgba(0,0,0,.10);}

.cal-card-wrap{margin:0 16px 10px;position:relative;overflow:hidden;border-radius:var(â€“radius);}
.cal-card-swipe-bg{position:absolute;inset:0;background:var(â€“green);display:flex;align-items:center;padding-left:20px;border-radius:var(â€“radius);}
.cal-card-swipe-bg.red-bg{background:var(â€“red);padding-left:0;padding-right:20px;justify-content:flex-end;}
.swipe-icon{font-size:24px;color:white;}
.cal-card{background:var(â€“bg2);border-radius:var(â€“radius);padding:14px 16px;box-shadow:var(â€“shadow-sm);cursor:pointer;position:relative;z-index:1;display:flex;align-items:flex-start;gap:12px;touch-action:pan-y;}
.cal-status{width:12px;height:12px;border-radius:50%;margin-top:4px;flex-shrink:0;}
.s-todo{background:#C7C7CC;}.s-doing{background:var(â€“orange);}.s-done{background:var(â€“green);}.s-skip{background:#C7C7CC;opacity:.4;}
.cal-body{flex:1;min-width:0;}
.cal-title{font-size:16px;font-weight:600;letter-spacing:-.3px;color:var(â€“label);}
.cal-note{font-size:13px;color:var(â€“label3);margin-top:3px;line-height:1.4;}

.section-block{margin:0 16px 24px;}
.section-block-header{font-size:13px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(â€“label3);padding:0 4px 8px;}

.stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:0 16px 24px;}
.stat-card{background:var(â€“bg2);border-radius:var(â€“radius);padding:14px 12px;box-shadow:var(â€“shadow-sm);text-align:center;}
.stat-num{font-size:28px;font-weight:800;letter-spacing:-1px;color:var(â€“green-dark);}
.stat-lbl{font-size:11px;font-weight:600;color:var(â€“label3);margin-top:2px;}

/* DETAIL VIEW */
.detail-view{position:fixed;inset:0;z-index:300;background:var(â€“bg);transform:translateX(100%);transition:transform .35s var(â€“ease-out);display:flex;flex-direction:column;}
.detail-view.open{transform:translateX(0);}
.detail-nav{height:calc(52px + env(safe-area-inset-top,0px));padding-top:env(safe-area-inset-top,0px);background:rgba(242,242,247,.88);backdrop-filter:blur(20px);border-bottom:.5px solid var(â€“separator);display:flex;align-items:center;gap:4px;padding-left:8px;padding-right:8px;flex-shrink:0;}
.detail-back{display:flex;align-items:center;gap:2px;background:none;border:none;cursor:pointer;color:var(â€“green-dark);padding:6px 8px;border-radius:8px;font-size:16px;font-weight:600;}
.detail-back:active{opacity:.5;}
.detail-nav-title{flex:1;font-size:17px;font-weight:700;letter-spacing:-.4px;color:var(â€“label);text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;padding:0 8px;}
.detail-edit{background:none;border:none;cursor:pointer;color:var(â€“blue);font-size:15px;font-weight:600;padding:6px 8px;}
.detail-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.detail-hero{background:linear-gradient(160deg,#1C3A1F 0%,#2D5A32 100%);padding:24px 20px 22px;position:relative;overflow:hidden;}
.detail-hero-name{font-size:28px;font-weight:800;letter-spacing:-1px;color:white;line-height:1.15;}
.detail-hero-sci{font-size:15px;color:rgba(255,255,255,.6);margin-top:4px;font-style:italic;}
.detail-hero-desc{font-size:14px;color:rgba(255,255,255,.75);margin-top:10px;line-height:1.5;}
.detail-section{margin:20px 16px 0;}
.detail-section-title{font-size:12px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(â€“label3);margin-bottom:8px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.info-cell{background:var(â€“bg2);border-radius:var(â€“radius-sm);padding:10px 12px;box-shadow:var(â€“shadow-sm);}
.info-cell.full{grid-column:1/-1;}
.info-cell-label{font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(â€“label3);margin-bottom:3px;}
.info-cell-val{font-size:14px;color:var(â€“label);line-height:1.4;}
.detail-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;padding-bottom:100px;}
.dtag{font-size:13px;font-weight:500;padding:5px 12px;border-radius:20px;background:var(â€“fill);color:var(â€“label2);}
.dtag.green{background:var(â€“green-soft);color:var(â€“green-dark);}

/* SHEETS */
.sheet-overlay{position:fixed;inset:0;z-index:400;background:rgba(0,0,0,0);pointer-events:none;transition:background .35s ease;display:flex;align-items:flex-end;justify-content:center;}
.sheet-overlay.open{background:rgba(0,0,0,0.45);pointer-events:all;}
.sheet{background:var(â€“bg2);border-radius:20px 20px 0 0;width:100%;transform:translateY(100%);transition:transform .42s var(â€“spring);display:flex;flex-direction:column;max-height:94dvh;overflow:hidden;}
.sheet-overlay.open .sheet{transform:translateY(0);}
.sheet-handle{width:36px;height:4px;border-radius:2px;background:var(â€“label4);margin:10px auto 0;flex-shrink:0;}
.sheet-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px;flex-shrink:0;}
.sheet-title{font-size:17px;font-weight:700;letter-spacing:-.4px;color:var(â€“label);}
.sheet-close{width:30px;height:30px;border-radius:50%;background:var(â€“fill);border:none;color:var(â€“label2);font-size:15px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.sheet-body{flex:1;overflow-y:auto;padding:0 20px;-webkit-overflow-scrolling:touch;}
.sheet-footer{padding:12px 20px calc(12px + env(safe-area-inset-bottom,0px));border-top:.5px solid var(â€“separator);flex-shrink:0;}

/* FORMS */
.form-section{font-size:12px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(â€“label3);margin:20px 0 8px;padding:0 2px;}
.form-group{margin-bottom:14px;}
.form-label{font-size:12px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;color:var(â€“label3);display:block;margin-bottom:6px;}
.form-ctrl{width:100%;padding:13px 14px;background:var(â€“bg3);border:none;border-radius:var(â€“radius-sm);font-family:â€˜Plus Jakarta Sansâ€™,sans-serif;font-size:15px;color:var(â€“label);outline:none;transition:background .15s ease,box-shadow .15s ease;-webkit-appearance:none;}
.form-ctrl:focus{background:white;box-shadow:0 0 0 3px rgba(52,199,89,.2);}
.form-ctrl::placeholder{color:var(â€“label3);}
textarea.form-ctrl{min-height:80px;resize:none;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.btn{width:100%;padding:15px;border-radius:var(â€“radius-sm);border:none;font-family:â€˜Plus Jakarta Sansâ€™,sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:transform .15s var(â€“spring),opacity .15s ease;display:flex;align-items:center;justify-content:center;gap:6px;}
.btn:active{transform:scale(0.97);opacity:.85;}
.btn-green{background:var(â€“green);color:white;}
.btn-outline{background:var(â€“fill);color:var(â€“label);}
.btn-red{background:var(â€“red);color:white;}

/* EMPTY STATE */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:64px 32px;text-align:center;gap:10px;}
.empty-icon{font-size:56px;margin-bottom:4px;}
.empty-title{font-size:20px;font-weight:700;letter-spacing:-.5px;color:var(â€“label);}
.empty-body{font-size:15px;color:var(â€“label3);line-height:1.5;max-width:240px;}

/* AUTH */
#auth-screen{position:fixed;inset:0;z-index:2000;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;overflow-y:auto;}
@media(min-width:768px){#auth-screen{background:var(â€“bg);}
#auth-screen .auth-form-wrap{background:white;padding:40px;border-radius:24px;box-shadow:var(â€“shadow-lg);width:100%;max-width:400px;}
}
.auth-form-wrap{width:100%;display:flex;flex-direction:column;align-items:center;}
.auth-logo{width:80px;height:80px;border-radius:20px;background:linear-gradient(145deg,#2ECC71,#27AE60);display:flex;align-items:center;justify-content:center;font-size:40px;box-shadow:0 8px 32px rgba(52,199,89,.35);margin-bottom:24px;}
.auth-title{font-size:28px;font-weight:800;letter-spacing:-.8px;color:var(â€“label);margin-bottom:4px;}
.auth-sub{font-size:15px;color:var(â€“label3);margin-bottom:32px;text-align:center;}
.auth-form{width:100%;display:flex;flex-direction:column;gap:12px;}
.auth-input{width:100%;padding:15px 16px;background:var(â€“bg3);border:none;border-radius:var(â€“radius-sm);font-family:â€˜Plus Jakarta Sansâ€™,sans-serif;font-size:16px;color:var(â€“label);outline:none;-webkit-appearance:none;}
.auth-input:focus{background:white;box-shadow:0 0 0 3px rgba(52,199,89,.2);}
.auth-btn{width:100%;padding:16px;border:none;border-radius:var(â€“radius-sm);font-family:â€˜Plus Jakarta Sansâ€™,sans-serif;font-size:16px;font-weight:700;cursor:pointer;background:var(â€“green);color:white;margin-top:4px;transition:transform .15s var(â€“spring),opacity .15s ease;}
.auth-btn:active{transform:scale(0.97);}
.auth-switch{font-size:15px;color:var(â€“label3);margin-top:20px;text-align:center;}
.auth-switch span{color:var(â€“blue);font-weight:600;cursor:pointer;}
.auth-error{font-size:14px;color:var(â€“red);text-align:center;min-height:20px;}
.auth-debug-box{width:100%;margin-top:12px;background:#FFF3F2;border:1.5px solid rgba(255,59,48,.25);border-radius:var(â€“radius-sm);overflow:hidden;display:none;}
.auth-debug-box.visible{display:block;}
.auth-debug-header{background:rgba(255,59,48,.10);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
.auth-debug-title{font-size:13px;font-weight:700;color:#C0392B;}
.auth-debug-copy{font-size:11px;font-weight:600;color:#C0392B;background:rgba(255,59,48,.12);border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-family:â€˜Plus Jakarta Sansâ€™,sans-serif;}
.auth-debug-body{padding:12px 14px;display:flex;flex-direction:column;gap:8px;}
.auth-debug-row{display:flex;flex-direction:column;gap:2px;}
.auth-debug-label{font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:#C0392B;opacity:.6;}
.auth-debug-val{font-size:12px;font-weight:500;color:#7B241C;word-break:break-all;font-family:monospace;background:rgba(255,59,48,.05);padding:4px 6px;border-radius:4px;}
.auth-debug-suggestion{margin-top:4px;padding:10px 14px;background:rgba(255,149,0,.08);border-top:1px solid rgba(255,149,0,.2);font-size:13px;color:#7D4A00;line-height:1.4;}
.auth-debug-suggestion strong{font-weight:700;}

/* TOAST */
#toast{position:fixed;bottom:calc(var(â€“tab-h) + 72px);left:50%;transform:translateX(-50%) translateY(20px);background:rgba(30,30,30,.92);backdrop-filter:blur(12px);color:white;padding:10px 18px;border-radius:20px;font-size:14px;font-weight:500;z-index:900;opacity:0;pointer-events:none;white-space:nowrap;transition:opacity .25s ease,transform .25s var(â€“spring);}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
@media(min-width:768px){#toast{bottom:40px;}}

/* QUICK LOG */
.quick-log-overlay{position:fixed;inset:0;z-index:500;pointer-events:none;display:flex;align-items:center;justify-content:center;}
.quick-log-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0);transition:background .25s ease;}
.quick-log-overlay.open{pointer-events:all;}
.quick-log-overlay.open .quick-log-backdrop{background:rgba(0,0,0,.5);}
.quick-log-sheet{background:var(â€“bg2);border-radius:var(â€“radius-lg);padding:20px;width:calc(100% - 48px);max-width:360px;transform:scale(0.85);opacity:0;transition:transform .3s var(â€“spring),opacity .25s ease;}
.quick-log-overlay.open .quick-log-sheet{transform:scale(1);opacity:1;}
.ql-title{font-size:17px;font-weight:700;color:var(â€“label);margin-bottom:4px;}
.ql-plant{font-size:13px;color:var(â€“label3);margin-bottom:16px;}
.ql-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.ql-btn{background:var(â€“bg3);border:none;border-radius:var(â€“radius-sm);padding:12px 8px;cursor:pointer;transition:transform .15s var(â€“spring);display:flex;flex-direction:column;align-items:center;gap:4px;}
.ql-btn:active{transform:scale(0.92);background:var(â€“green-soft);}
.ql-btn span{font-size:11px;font-weight:600;color:var(â€“label2);}
.ql-cancel{width:100%;padding:13px;border:none;border-radius:var(â€“radius-sm);background:var(â€“fill);color:var(â€“label2);font-family:â€˜Plus Jakarta Sansâ€™,sans-serif;font-size:15px;font-weight:600;cursor:pointer;}

/* SETTINGS */
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;transition:background .12s ease;}
.settings-row:active{background:var(â€“fill2);}
.settings-row-left{display:flex;align-items:center;gap:12px;}
.settings-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;}
.settings-label{font-size:16px;font-weight:500;color:var(â€“label);}
.settings-arrow{color:var(â€“label4);font-size:13px;}

/* SEARCH */
.search-overlay{position:fixed;inset:0;z-index:600;background:rgba(242,242,247,0);pointer-events:none;transition:background .3s ease;display:flex;flex-direction:column;}
.search-overlay.open{background:rgba(242,242,247,1);pointer-events:all;}
.search-overlay.open .search-bar-wrap{transform:translateY(0);opacity:1;}
.search-overlay.open .search-results{opacity:1;transform:translateY(0);}
.search-bar-wrap{padding:calc(env(safe-area-inset-top,0px) + 12px) 16px 8px;display:flex;align-items:center;gap:10px;background:rgba(242,242,247,0.95);backdrop-filter:blur(20px);transform:translateY(-20px);opacity:0;transition:transform .3s var(â€“spring),opacity .25s ease;flex-shrink:0;}
.search-input-wrap{flex:1;display:flex;align-items:center;gap:8px;background:white;border-radius:12px;padding:10px 14px;box-shadow:var(â€“shadow-md);}
.search-input{flex:1;border:none;outline:none;font-family:â€˜Plus Jakarta Sansâ€™,sans-serif;font-size:16px;font-weight:500;color:var(â€“label);background:transparent;}
.search-input::placeholder{color:var(â€“label3);}
.search-cancel{font-size:16px;font-weight:600;color:var(â€“blue);cursor:pointer;white-space:nowrap;padding:8px 4px;}
.search-results{flex:1;overflow-y:auto;padding:8px 16px;opacity:0;transform:translateY(10px);transition:opacity .3s ease .1s,transform .3s var(â€“spring) .1s;}
.search-section-header{font-size:12px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(â€“label3);padding:12px 4px 6px;}
.search-item{background:var(â€“bg2);border-radius:var(â€“radius-sm);padding:12px 14px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:10px;}
.search-item:active{transform:scale(0.98);}
.search-item-icon{width:32px;height:32px;border-radius:8px;background:var(â€“green-soft);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.search-item-title{font-size:15px;font-weight:600;color:var(â€“label);}
.search-item-sub{font-size:12px;color:var(â€“label3);margin-top:2px;}
.search-highlight{color:var(â€“green);background:var(â€“green-soft);border-radius:3px;padding:0 2px;}
.search-empty{text-align:center;padding:40px 20px;color:var(â€“label3);font-size:15px;}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:3000;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .5s ease;}
#splash.out{opacity:0;pointer-events:none;}
.splash-app-icon{width:100px;height:100px;border-radius:24px;background:linear-gradient(145deg,#2ECC71,#27AE60);display:flex;align-items:center;justify-content:center;font-size:52px;box-shadow:0 8px 32px rgba(52,199,89,.35);animation:sBounce .8s var(â€“spring) .2s both;}
@keyframes sBounce{from{transform:scale(0);opacity:0;}to{transform:scale(1);opacity:1;}}
.splash-name{font-size:28px;font-weight:800;letter-spacing:-.8px;color:#1C1C1E;animation:sFadeUp .5s ease .6s both;}
.splash-sub{font-size:15px;color:#8E8E93;animation:sFadeUp .5s ease .75s both;}
@keyframes sFadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

#confetti-canvas{position:fixed;inset:0;z-index:800;pointer-events:none;}
</style>

</head>
<body>

<div id="splash">
  <div class="splash-app-icon">ğŸŒ¿</div>
  <div class="splash-name">Garden</div>
  <div class="splash-sub">Il tuo archivio botanico</div>
</div>

<canvas id="confetti-canvas"></canvas>

<div id="toast"></div>

<!-- AUTH -->

<div id="auth-screen" style="display:none">
  <div class="auth-form-wrap">
    <div class="auth-logo">ğŸŒ¿</div>
    <div class="auth-title">Garden</div>
    <div class="auth-sub" id="auth-sub">Il tuo archivio botanico personale</div>
    <div class="auth-form">
      <input class="auth-input" id="auth-email" type="email" placeholder="Email" autocomplete="email">
      <input class="auth-input" id="auth-pass" type="password" placeholder="Password" autocomplete="current-password">
      <div class="auth-error" id="auth-error"></div>
      <div class="auth-debug-box" id="auth-debug-box">
        <div class="auth-debug-header">
          <span class="auth-debug-title">ğŸ” Dettaglio errore</span>
          <button class="auth-debug-copy" onclick="copyDebugInfo()">ğŸ“‹ Copia</button>
        </div>
        <div class="auth-debug-body" id="auth-debug-body"></div>
        <div class="auth-debug-suggestion" id="auth-debug-suggestion"></div>
      </div>
      <button class="auth-btn" id="auth-submit-btn" onclick="authSubmit()">Accedi</button>
    </div>
    <div class="auth-switch" id="auth-switch">Non hai un account? <span onclick="toggleAuthMode()">Registrati</span></div>
  </div>
</div>

<button class="fab" id="fab" style="display:none">+</button>

<!-- APP -->

<div id="app" style="display:none">
  <div class="nav-bar" id="nav-bar">
    <div class="nav-left">
      <button class="nav-btn gray" id="btn-settings">âš™ï¸</button>
    </div>
    <span class="nav-title" id="nav-bar-title">Le mie piante</span>
    <div class="nav-right">
      <button class="nav-btn gray" id="btn-search">ğŸ”</button>
      <button class="nav-btn green" id="btn-add-quick">ï¼‹</button>
    </div>
  </div>

  <div class="app-body">
    <!-- SIDEBAR (iPad/desktop only) -->
    <nav class="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-icon">ğŸŒ¿</div>
        <span class="sidebar-logo-name">Garden</span>
      </div>
      <div class="sidebar-nav">
        <button class="sidebar-item active" data-tab="piante">
          <span class="si-icon">ğŸŒ¸</span><span class="si-label">Piante</span>
        </button>
        <button class="sidebar-item" data-tab="journal">
          <span class="si-icon">ğŸ“–</span><span class="si-label">Journal</span>
        </button>
        <button class="sidebar-item" data-tab="knowledge">
          <span class="si-icon">ğŸ“š</span><span class="si-label">Knowledge</span>
        </button>
        <button class="sidebar-item" data-tab="prodotti">
          <span class="si-icon">ğŸ§´</span><span class="si-label">Prodotti</span>
        </button>
        <button class="sidebar-item" data-tab="calendario">
          <span class="si-icon">ğŸ“…</span><span class="si-label">Calendario</span>
        </button>
      </div>
      <div class="sidebar-footer">
        <button class="sidebar-settings" onclick="openSheet('sheet-settings')">
          <span style="font-size:18px">âš™ï¸</span>
          <span id="sidebar-email-label" style="font-size:13px;color:var(--label3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Impostazioni</span>
        </button>
      </div>
    </nav>

```
<!-- MAIN SCROLL AREA -->
<div class="scroll-area" id="scroll-area">
  <div class="section active" id="sec-piante">
    <div class="large-title-wrap">
      <h1 class="large-title">Le mie <span>piante</span></h1>
      <p class="large-subtitle" id="piante-subtitle">Archivio botanico personale</p>
    </div>
    <div class="stat-row" id="piante-stats" style="display:none">
      <div class="stat-card"><div class="stat-num" id="stat-piante">0</div><div class="stat-lbl">Piante</div></div>
      <div class="stat-card"><div class="stat-num" id="stat-journal">0</div><div class="stat-lbl">AttivitÃ </div></div>
      <div class="stat-card"><div class="stat-num" id="stat-cal">0</div><div class="stat-lbl">Lavori</div></div>
    </div>
    <div class="seasonal-banner" id="seasonal-banner" style="display:none"></div>
    <div id="piante-list"></div>
  </div>

  <div class="section" id="sec-journal">
    <div class="large-title-wrap">
      <h1 class="large-title">Garden <span>Journal</span></h1>
      <p class="large-subtitle" id="journal-subtitle">Diario delle attivitÃ </p>
    </div>
    <div id="journal-list"></div>
  </div>

  <div class="section" id="sec-knowledge">
    <div class="large-title-wrap"><h1 class="large-title"><span>Know</span>ledge</h1><p class="large-subtitle">Biblioteca botanica personale</p></div>
    <div id="knowledge-list"></div>
  </div>

  <div class="section" id="sec-prodotti">
    <div class="large-title-wrap"><h1 class="large-title"><span>Pro</span>dotti</h1><p class="large-subtitle">Inventario fertilizzanti e prodotti</p></div>
    <div id="prodotti-list"></div>
  </div>

  <div class="section" id="sec-calendario">
    <div class="large-title-wrap"><h1 class="large-title"><span>Calen</span>dario</h1><p class="large-subtitle">Lavori mensili in giardino</p></div>
    <div class="month-strip" id="month-strip"></div>
    <div class="seg-wrap"><div class="seg-ctrl" id="status-seg">
      <button class="seg-btn active" data-s="all">Tutti</button>
      <button class="seg-btn" data-s="todo">Da fare</button>
      <button class="seg-btn" data-s="doing">In corso</button>
      <button class="seg-btn" data-s="done">Fatto</button>
    </div></div>
    <div id="calendario-list"></div>
  </div>
</div>
```

  </div>

  <!-- MOBILE TAB BAR -->

  <nav class="tab-bar">
    <button class="tab-item active" data-tab="piante"><span class="tab-icon">ğŸŒ¸</span><span class="tab-label">Piante</span></button>
    <button class="tab-item" data-tab="journal"><span class="tab-icon">ğŸ“–</span><span class="tab-label">Journal</span></button>
    <button class="tab-item" data-tab="knowledge"><span class="tab-icon">ğŸ“š</span><span class="tab-label">Knowledge</span></button>
    <button class="tab-item" data-tab="prodotti"><span class="tab-icon">ğŸ§´</span><span class="tab-label">Prodotti</span></button>
    <button class="tab-item" data-tab="calendario"><span class="tab-icon">ğŸ“…</span><span class="tab-label">Calendario</span></button>
  </nav>
</div>

<!-- SEARCH -->

<div class="search-overlay" id="search-overlay">
  <div class="search-bar-wrap">
    <div class="search-input-wrap">
      <span style="font-size:16px;color:var(--label3)">ğŸ”</span>
      <input class="search-input" id="search-input" placeholder="Cerca in Gardenâ€¦" autocomplete="off">
    </div>
    <span class="search-cancel" onclick="closeSearch()">Annulla</span>
  </div>
  <div class="search-results" id="search-results">
    <div class="search-empty">Inizia a digitare per cercare</div>
  </div>
</div>

<!-- QUICK LOG -->

<div class="quick-log-overlay" id="quick-log">
  <div class="quick-log-backdrop" onclick="closeQuickLog()"></div>
  <div class="quick-log-sheet">
    <div class="ql-title">Log rapido ğŸ“</div>
    <div class="ql-plant" id="ql-plant-name">â€”</div>
    <div class="ql-grid" id="ql-grid"></div>
    <button class="ql-cancel" onclick="closeQuickLog()">Annulla</button>
  </div>
</div>

<!-- SETTINGS -->

<div class="sheet-overlay" id="sheet-settings">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title">âš™ï¸ Impostazioni</span><button class="sheet-close" onclick="closeSheet('sheet-settings')">âœ•</button></div>
    <div class="sheet-body">
      <p class="form-section">Account</p>
      <div class="list-card">
        <div class="settings-row">
          <div class="settings-row-left"><div class="settings-icon" style="background:rgba(52,199,89,.12)">ğŸ‘¤</div><span class="settings-label" id="settings-email">â€”</span></div>
        </div>
        <div class="settings-row" onclick="signOut()">
          <div class="settings-row-left"><div class="settings-icon" style="background:rgba(255,59,48,.12)">ğŸšª</div><span class="settings-label" style="color:var(--red)">Esci</span></div>
          <span class="settings-arrow">â€º</span>
        </div>
      </div>
      <p class="form-section">App</p>
      <div class="list-card">
        <div class="settings-row">
          <div class="settings-row-left"><div class="settings-icon" style="background:rgba(175,82,222,.12)">ğŸŒ¿</div><span class="settings-label">Garden App v4.1</span></div>
          <span style="font-size:13px;color:var(--label3)">2026</span>
        </div>
      </div>
      <div style="height:20px"></div>
    </div>
  </div>
</div>

<!-- PIANTA SHEET -->

<div class="sheet-overlay" id="sheet-pianta">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title" id="sheet-pianta-title">Nuova pianta</span><button class="sheet-close" onclick="closeSheet('sheet-pianta')">âœ•</button></div>
    <div class="sheet-body">
      <p class="form-section">Dati principali</p>
      <div class="form-group"><label class="form-label">Nome comune *</label><input class="form-ctrl" id="p-nome" placeholder="es. Rosa, Lavandaâ€¦"></div>
      <div class="form-group"><label class="form-label">Nome scientifico</label><input class="form-ctrl" id="p-sci" placeholder="es. Rosa canina"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Famiglia</label><input class="form-ctrl" id="p-fam" placeholder="es. Rosaceae"></div>
        <div class="form-group"><label class="form-label">Tipologia</label>
          <select class="form-ctrl" id="p-tipo"><option value="">â€”</option><option>Albero</option><option>Arbusto</option><option>Erbacea</option><option>Rampicante</option><option>Bulbosa</option><option>Succulenta</option><option>Annuale</option><option>Perenne</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">In breve</label><input class="form-ctrl" id="p-breve" placeholder="Descrizione sinteticaâ€¦"></div>
      <div class="form-group"><label class="form-label">Storia e curiositÃ </label><textarea class="form-ctrl" id="p-storia"></textarea></div>
      <p class="form-section">Coltivazione</p>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Esposizione</label>
          <select class="form-ctrl" id="p-esp"><option value="">â€”</option><option>Sole pieno</option><option>Mezz'ombra</option><option>Ombra</option></select></div>
        <div class="form-group"><label class="form-label">Fioritura</label><input class="form-ctrl" id="p-fior" placeholder="es. Aprâ€“Giu"></div>
      </div>
      <div class="form-group"><label class="form-label">Note fioritura</label><input class="form-ctrl" id="p-nfior"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Altezza</label><input class="form-ctrl" id="p-alt" placeholder="es. 50â€“150 cm"></div>
        <div class="form-group"><label class="form-label">RusticitÃ </label><input class="form-ctrl" id="p-rust" placeholder="es. H4"></div>
      </div>
      <div class="form-group"><label class="form-label">Terreno</label><input class="form-ctrl" id="p-terr"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Innaffiatura</label><input class="form-ctrl" id="p-inn"></div>
        <div class="form-group"><label class="form-label">Potatura</label><input class="form-ctrl" id="p-pot"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Concimazione</label><input class="form-ctrl" id="p-con"></div>
        <div class="form-group"><label class="form-label">Propagazione</label><input class="form-ctrl" id="p-prop"></div>
      </div>
      <div class="form-group"><label class="form-label">Lavori periodici</label><textarea class="form-ctrl" id="p-lav" style="min-height:60px"></textarea></div>
      <div class="form-group"><label class="form-label">Pacciamatura</label><input class="form-ctrl" id="p-pacc"></div>
      <div class="form-group"><label class="form-label">Malattie e parassiti</label><textarea class="form-ctrl" id="p-mal" style="min-height:60px"></textarea></div>
      <p class="form-section">Note personali</p>
      <div class="form-group"><label class="form-label">Posizione in giardino</label><input class="form-ctrl" id="p-pos"></div>
      <div class="form-group"><label class="form-label">Note</label><textarea class="form-ctrl" id="p-note"></textarea></div>
      <div class="form-group"><label class="form-label">Link utili</label><input class="form-ctrl" id="p-link" placeholder="https://â€¦"></div>
      <div class="form-group"><label class="form-label">RHS Website</label><input class="form-ctrl" id="p-rhs" placeholder="https://rhs.org.uk/â€¦"></div>
      <input type="hidden" id="p-id"><div style="height:8px"></div>
    </div>
    <div class="sheet-footer"><button class="btn btn-green" onclick="savePianta()">Salva pianta</button></div>
  </div>
</div>

<!-- JOURNAL SHEET -->

<div class="sheet-overlay" id="sheet-journal">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title" id="sheet-journal-title">Nuova attivitÃ </span><button class="sheet-close" onclick="closeSheet('sheet-journal')">âœ•</button></div>
    <div class="sheet-body">
      <div class="form-group" style="margin-top:8px"><label class="form-label">Tipo attivitÃ  *</label>
        <select class="form-ctrl" id="j-att"><option value="">Scegliâ€¦</option><option>Potatura</option><option>Semina</option><option>Innaffiatura</option><option>Trattamento</option><option>Concimazione</option><option>Rinvaso</option><option>Trapianto</option><option>Raccolta</option><option>Pacciamatura</option><option>Pulizia</option><option>Osservazione</option><option>Altro</option></select></div>
      <div class="form-group"><label class="form-label">Data *</label><input class="form-ctrl" id="j-data" type="date"></div>
      <div class="form-group"><label class="form-label">Pianta</label><select class="form-ctrl" id="j-pianta"><option value="">â€” nessuna â€”</option></select></div>
      <div class="form-group"><label class="form-label">Note</label><textarea class="form-ctrl" id="j-note"></textarea></div>
      <input type="hidden" id="j-id">
    </div>
    <div class="sheet-footer"><button class="btn btn-green" onclick="saveJournal()">Salva attivitÃ </button></div>
  </div>
</div>

<!-- KNOWLEDGE SHEET -->

<div class="sheet-overlay" id="sheet-knowledge">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title" id="sheet-knowledge-title">Nuova risorsa</span><button class="sheet-close" onclick="closeSheet('sheet-knowledge')">âœ•</button></div>
    <div class="sheet-body">
      <div class="form-group" style="margin-top:8px"><label class="form-label">Titolo *</label><input class="form-ctrl" id="k-tit" placeholder="es. Come potare le roseâ€¦"></div>
      <div class="form-group"><label class="form-label">Contenuto / Note</label><textarea class="form-ctrl" id="k-note"></textarea></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Fonte</label><input class="form-ctrl" id="k-src"></div>
        <div class="form-group"><label class="form-label">Topic</label>
          <select class="form-ctrl" id="k-topic"><option value="">â€”</option><option>Potatura</option><option>Malattie</option><option>Botanica</option><option>Fertilizzazione</option><option>Irrigazione</option><option>Semina</option><option>Parassiti</option><option>Terreno</option><option>Altro</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">URL</label><input class="form-ctrl" id="k-url" placeholder="https://â€¦"></div>
      <div class="form-group"><label class="form-label">Pianta collegata</label><select class="form-ctrl" id="k-pianta"><option value="">â€” nessuna â€”</option></select></div>
      <input type="hidden" id="k-id">
    </div>
    <div class="sheet-footer"><button class="btn btn-green" onclick="saveKnowledge()">Salva risorsa</button></div>
  </div>
</div>

<!-- PRODOTTO SHEET -->

<div class="sheet-overlay" id="sheet-prodotto">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title" id="sheet-prodotto-title">Nuovo prodotto</span><button class="sheet-close" onclick="closeSheet('sheet-prodotto')">âœ•</button></div>
    <div class="sheet-body">
      <div class="form-group" style="margin-top:8px"><label class="form-label">Nome *</label><input class="form-ctrl" id="pr-nome"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Categoria</label>
          <select class="form-ctrl" id="pr-cat"><option value="">â€”</option><option>Fertilizzante</option><option>Antiparassitario</option><option>Fungicida</option><option>Terriccio</option><option>Ammendante</option><option>Pacciame</option><option>Stimolante</option><option>Erbicida</option><option>Strumento</option><option>Altro</option></select></div>
        <div class="form-group"><label class="form-label">Ultimo acquisto</label><input class="form-ctrl" id="pr-acq" type="date"></div>
      </div>
      <div class="form-group"><label class="form-label">Note</label><textarea class="form-ctrl" id="pr-note"></textarea></div>
      <div class="form-group"><label class="form-label">Link prodotto</label><input class="form-ctrl" id="pr-url" placeholder="https://â€¦"></div>
      <input type="hidden" id="pr-id">
    </div>
    <div class="sheet-footer"><button class="btn btn-green" onclick="saveProdotto()">Salva prodotto</button></div>
  </div>
</div>

<!-- CALENDARIO SHEET -->

<div class="sheet-overlay" id="sheet-cal">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header"><span class="sheet-title" id="sheet-cal-title">Nuovo lavoro</span><button class="sheet-close" onclick="closeSheet('sheet-cal')">âœ•</button></div>
    <div class="sheet-body">
      <div class="form-group" style="margin-top:8px"><label class="form-label">AttivitÃ  *</label>
        <select class="form-ctrl" id="c-att"><option value="">Tipo di lavoroâ€¦</option><option>Potatura</option><option>Semina</option><option>Trapianto</option><option>Concimazione</option><option>Trattamento fitosanitario</option><option>Raccolta</option><option>Pacciamatura</option><option>Irrigazione programmata</option><option>Rinvaso</option><option>Pulizia</option><option>Altro</option></select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Mese *</label>
          <select class="form-ctrl" id="c-mese"><option value="">â€”</option><option>Gennaio</option><option>Febbraio</option><option>Marzo</option><option>Aprile</option><option>Maggio</option><option>Giugno</option><option>Luglio</option><option>Agosto</option><option>Settembre</option><option>Ottobre</option><option>Novembre</option><option>Dicembre</option></select></div>
        <div class="form-group"><label class="form-label">Stato</label>
          <select class="form-ctrl" id="c-stato"><option value="todo">Da fare</option><option value="doing">In corso</option><option value="done">Completato</option><option value="skip">Non necessario</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Pianta</label><select class="form-ctrl" id="c-pianta"><option value="">â€” generale â€”</option></select></div>
      <div class="form-group"><label class="form-label">Note</label><textarea class="form-ctrl" id="c-note"></textarea></div>
      <input type="hidden" id="c-id">
    </div>
    <div class="sheet-footer"><button class="btn btn-green" onclick="saveCal()">Salva lavoro</button></div>
  </div>
</div>

<!-- DETAIL VIEWS -->

<div class="detail-view" id="detail-pianta">
  <div class="detail-nav">
    <button class="detail-back" onclick="closeDetail('detail-pianta')">â€¹ Indietro</button>
    <span class="detail-nav-title" id="dpn-title">â€”</span>
    <button class="detail-edit" id="dpn-edit">Modifica</button>
  </div>
  <div class="detail-body" id="dpn-body"></div>
</div>
<div class="detail-view" id="detail-journal">
  <div class="detail-nav">
    <button class="detail-back" onclick="closeDetail('detail-journal')">â€¹ Indietro</button>
    <span class="detail-nav-title">AttivitÃ </span>
    <button class="detail-edit" id="djn-edit">Modifica</button>
  </div>
  <div class="detail-body" id="djn-body"></div>
</div>
<div class="detail-view" id="detail-knowledge">
  <div class="detail-nav">
    <button class="detail-back" onclick="closeDetail('detail-knowledge')">â€¹ Indietro</button>
    <span class="detail-nav-title">Risorsa</span>
    <button class="detail-edit" id="dkn-edit">Modifica</button>
  </div>
  <div class="detail-body" id="dkn-body"></div>
</div>

<script>
const SUPA_URL='https://amvxjsiwcgszvjjkspnv.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtdnhqc2l3Y2dzenZqamtzcG52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNDYwMDEsImV4cCI6MjA4NzcyMjAwMX0.PR0icBAibj2bm8nCYWLYJwZ4_WyRooekh_pUW9MTuzY';

let lastDebugInfo={};
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showDebugBox(info){
  lastDebugInfo=info;
  const box=document.getElementById('auth-debug-box');
  const body=document.getElementById('auth-debug-body');
  const suggestion=document.getElementById('auth-debug-suggestion');
  const rows=[{label:'HTTP Status',val:info.httpStatus},{label:'Codice errore',val:info.errorCode},{label:'Messaggio',val:info.message},{label:'error_description',val:info.errorDescription},{label:'Endpoint',val:info.endpoint},{label:'Risposta completa',val:info.rawResponse}].filter(r=>r.val&&r.val!=='â€”');
  body.innerHTML=rows.map(r=>`<div class="auth-debug-row"><span class="auth-debug-label">${r.label}</span><span class="auth-debug-val">${escHtml(String(r.val))}</span></div>`).join('');
  const msg=(info.message||'').toLowerCase();
  let hint='';
  if(info.httpStatus===400&&msg.includes('password'))hint='<strong>ğŸ’¡</strong> Password troppo corta: minimo 6 caratteri.';
  else if(info.httpStatus===422)hint='<strong>ğŸ’¡</strong> Dati non validi: verifica email e password (min. 6 caratteri).';
  else if(info.httpStatus===429)hint='<strong>ğŸ’¡</strong> Troppi tentativi. Aspetta qualche minuto.';
  else if(msg.includes('email not confirmed'))hint='<strong>ğŸ’¡</strong> Controlla la tua email e clicca il link di conferma.';
  else if(msg.includes('user already registered'))hint='<strong>ğŸ’¡</strong> Email giÃ  registrata. Prova ad accedere invece di registrarti.';
  else if(info.httpStatus===0)hint='<strong>ğŸ’¡</strong> Impossibile raggiungere il server. Verifica la connessione internet.';
  else hint='<strong>ğŸ’¡</strong> Copia il dettaglio e condividilo per analisi.';
  suggestion.innerHTML=hint;
  box.classList.add('visible');
}
function hideDebugBox(){document.getElementById('auth-debug-box').classList.remove('visible');}
function copyDebugInfo(){const text=Object.entries(lastDebugInfo).filter(([,v])=>v).map(([k,v])=>`${k}: ${v}`).join('\n');navigator.clipboard?.writeText(text).then(()=>toast('ğŸ“‹ Info copiate!'));}

let currentUser=null,authToken=null,authMode='login';
async function authSubmit(){
  const email=document.getElementById('auth-email').value.trim();
  const pass=document.getElementById('auth-pass').value;
  const errEl=document.getElementById('auth-error');
  errEl.textContent='';hideDebugBox();
  if(!email||!pass){errEl.textContent='Inserisci email e password';return;}
  const btn=document.getElementById('auth-submit-btn');
  btn.textContent='â€¦';btn.disabled=true;
  const endpoint=authMode==='login'?'/auth/v1/token?grant_type=password':'/auth/v1/signup';
  const fullUrl=SUPA_URL+endpoint;
  try{
    const res=await fetch(fullUrl,{method:'POST',headers:{'Content-Type':'application/json','apikey':SUPA_KEY},body:JSON.stringify({email,password:pass})});
    let data={},rawResponse='';
    try{rawResponse=await res.text();data=JSON.parse(rawResponse);}catch(_){}
    if(!res.ok){
      const msg=data.error_description||data.message||data.error||`Errore HTTP ${res.status}`;
      errEl.textContent='âš ï¸ '+msg;
      showDebugBox({httpStatus:res.status,errorCode:data.error||data.code||'â€”',message:data.message||data.error||'â€”',errorDescription:data.error_description||'â€”',endpoint:fullUrl,rawResponse:rawResponse.length>300?rawResponse.slice(0,300)+'â€¦':rawResponse});
      btn.textContent=authMode==='login'?'Accedi':'Registrati';btn.disabled=false;return;
    }
    if(authMode==='register'&&!data.access_token){
      errEl.style.color='var(--green-dark)';errEl.textContent='âœ… Controlla la tua email per confermare!';
      btn.textContent='Registrati';btn.disabled=false;return;
    }
    authToken=data.access_token;currentUser=data.user;
    saveSession(authToken,currentUser,email);
    document.getElementById('auth-screen').style.display='none';
    document.getElementById('settings-email').textContent=email;
    document.getElementById('sidebar-email-label').textContent=email;
    errEl.style.color='';showApp();
  }catch(e){
    errEl.textContent='âš ï¸ Errore di rete: '+e.message;
    showDebugBox({httpStatus:0,errorCode:'FETCH_ERROR',message:e.message,errorDescription:'Impossibile contattare il server.',endpoint:fullUrl,rawResponse:String(e)});
    btn.textContent=authMode==='login'?'Accedi':'Registrati';btn.disabled=false;
  }
}
function toggleAuthMode(){
  authMode=authMode==='login'?'register':'login';
  hideDebugBox();document.getElementById('auth-error').textContent='';document.getElementById('auth-error').style.color='';
  document.getElementById('auth-submit-btn').textContent=authMode==='login'?'Accedi':'Registrati';
  document.getElementById('auth-switch').innerHTML=authMode==='login'?'Non hai un account? <span onclick="toggleAuthMode()">Registrati</span>':'Hai giÃ  un account? <span onclick="toggleAuthMode()">Accedi</span>';
}
function signOut(){
  authToken=null;currentUser=null;plants=[];journal=[];knowledge=[];prodotti=[];calendario=[];
  clearSession();
  document.getElementById('app').style.display='none';document.getElementById('fab').style.display='none';
  document.getElementById('auth-screen').style.display='flex';
  document.getElementById('auth-email').value='';document.getElementById('auth-pass').value='';
  document.getElementById('auth-error').textContent='';hideDebugBox();closeSheet('sheet-settings');toast('ğŸ‘‹ Uscito!');
}
async function showApp(){document.getElementById('app').style.display='flex';document.getElementById('fab').style.display='flex';await loadAllData();renderAll();}

let plants=[],journal=[],knowledge=[],prodotti=[],calendario=[];
function authHeaders(){return{'Content-Type':'application/json','apikey':SUPA_KEY,'Authorization':`Bearer ${authToken}`,'Prefer':'return=representation'};}
async function dbGet(table){const r=await fetch(`${SUPA_URL}/rest/v1/${table}?select=*&order=created_at.asc`,{headers:authHeaders()});if(!r.ok)return[];return r.json();}
async function dbInsert(table,obj){delete obj.id;const r=await fetch(`${SUPA_URL}/rest/v1/${table}`,{method:'POST',headers:authHeaders(),body:JSON.stringify(obj)});const data=await r.json();return Array.isArray(data)?data[0]:data;}
async function dbUpdate(table,id,obj){delete obj.id;delete obj.user_id;delete obj.created_at;const r=await fetch(`${SUPA_URL}/rest/v1/${table}?id=eq.${id}`,{method:'PATCH',headers:authHeaders(),body:JSON.stringify(obj)});const data=await r.json();return Array.isArray(data)?data[0]:data;}
async function dbDelete(table,id){await fetch(`${SUPA_URL}/rest/v1/${table}?id=eq.${id}`,{method:'DELETE',headers:authHeaders()});}
async function loadAllData(){toast('ğŸ”„ Caricamentoâ€¦');try{[plants,journal,knowledge,prodotti,calendario]=await Promise.all([dbGet('piante'),dbGet('journal'),dbGet('knowledge'),dbGet('prodotti'),dbGet('calendario')]);toast('âœ… Dati caricati!');}catch(e){toast('âš ï¸ Errore caricamento');}}

const MESI=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
let curTab='piante',curMonth=MESI[new Date().getMonth()],curStatusFilter='all',quickLogPid='';
const fmtDate=d=>d?new Date(d).toLocaleDateString('it-IT',{day:'2-digit',month:'short',year:'numeric'}):'';
const pName=id=>{const p=plants.find(x=>x.id===id);return p?p.nome||p.sci:'â€”';};
const tipEmoji={Albero:'ğŸŒ³',Arbusto:'ğŸŒ¿',Erbacea:'ğŸŒ±',Rampicante:'ğŸƒ',Bulbosa:'ğŸŒ·',Succulenta:'ğŸŒµ',Annuale:'ğŸŒ¼',Perenne:'ğŸŒº'};
const catEmoji={'Fertilizzante':'ğŸ’Š','Antiparassitario':'ğŸ›¡ï¸','Fungicida':'ğŸ„','Terriccio':'ğŸª¨','Ammendante':'ğŸŒ','Pacciame':'ğŸŒ¾','Stimolante':'âš¡','Erbicida':'âš ï¸','Strumento':'ğŸ”§','Altro':'ğŸ“¦'};
const actEmoji={Potatura:'âœ‚ï¸',Semina:'ğŸŒ±',Innaffiatura:'ğŸ’§',Trattamento:'ğŸ§ª',Concimazione:'ğŸ’Š',Rinvaso:'ğŸª´',Trapianto:'â›ï¸',Raccolta:'ğŸ§º',Pacciamatura:'ğŸŒ¾',Pulizia:'ğŸ§¹',Osservazione:'ğŸ”',Altro:'ğŸ“'};
const statusMeta={todo:{cls:'s-todo',lbl:'Da fare'},doing:{cls:'s-doing',lbl:'In corso'},done:{cls:'s-done',lbl:'Completato âœ“'},skip:{cls:'s-skip',lbl:'Non necessario'}};
function chip(i,t){return t?`<span class="meta-chip">${i} ${t}</span>`:'';}
function infoCell(l,v,f=false){return v?`<div class="info-cell${f?' full':''}"><div class="info-cell-label">${l}</div><div class="info-cell-val">${v}</div></div>`:'';}
function vt(id){return document.getElementById(id)?.value.trim()||'';}
function vs(id){return document.getElementById(id)?.value||'';}

function calcHealthScore(p){const fields=['sci','fam','tipo','breve','esp','fior','alt','rust','terr','inn','pot','con','prop'];const filled=fields.filter(k=>p[k]&&p[k].trim()).length;return Math.min(100,Math.round((filled/fields.length)*55)+journal.filter(j=>j.pid===p.id).slice(-3).length*10+calendario.filter(c=>c.pid===p.id&&c.stato==='done').length*5);}
function healthColor(s){return s>=75?{stroke:'#34C759',text:'#248A3D'}:s>=45?{stroke:'#FF9500',text:'#B06A00'}:{stroke:'#FF3B30',text:'#C0392B'};}
function renderHealthRing(score){const r=17,circ=2*Math.PI*r,offset=circ-(score/100)*circ,col=healthColor(score);return `<div class="health-ring"><svg width="44" height="44" viewBox="0 0 44 44"><circle class="ring-bg" cx="22" cy="22" r="${r}"/><circle class="ring-fg" cx="22" cy="22" r="${r}" stroke="${col.stroke}" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/></svg><div class="health-score-text" style="color:${col.text}">${score}</div></div>`;}

const SEASONAL_TASKS={Gennaio:['Riposa il giardino, pota piante decidue','Pianifica acquisti e semina indoor','Proteggi specie sensibili dal gelo'],Febbraio:['Inizio potatura rose e arbusti estivi','Semina indoor pomodori e peperoni','Controlla gli svernanti'],Marzo:['Potatura di rinnovo su arbusti fioriti','Concima il prato con azoto','Prepara il terreno per le semine'],Aprile:['Trapianta le piante invernate','Semina diretta in campo aperto','Prima concimazione stagionale'],Maggio:['Pacciamatura per conservare umiditÃ ','Taglia i rami secchi','Innaffiatura regolare'],Giugno:['Irrigazione nelle ore fresche','Trattamenti preventivi antiafide','Raccolta erbe aromatiche'],Luglio:['Irrigazione profonda ogni 2-3 giorni','Ombreggiatura per specie delicate','Pausa semina'],Agosto:['Raccolta semi per prossima stagione','Taglia siepi','Prepara letti per bulbi autunnali'],Settembre:['Piantumazione alberi e arbusti','Semina prati e concimazione','Metti a dimora bulbi primaverili'],Ottobre:['Potatura di pulizia post-estate','Raccolta foglie per compost','Protezione invernale'],Novembre:['Ripara le specie non rustiche','Concimazione organica','Ultimo taglio erba'],Dicembre:['Pianifica acquisti per prossimo anno','Manutenzione attrezzi','Controlla bulbi in cantina']};
function generateSeasonalTips(){const banner=document.getElementById('seasonal-banner');if(!plants.length){banner.style.display='none';return;}banner.style.display='block';const tips=SEASONAL_TASKS[curMonth]||[];const extra=[];const todo=calendario.filter(c=>c.mese===curMonth&&c.stato==='todo');if(todo.length)extra.push(`ğŸ“‹ ${todo.length} lavori pianificati da completare`);const allTips=[...extra,...tips].slice(0,3);banner.innerHTML=`<div class="sb-label">ğŸŒ¿ Consigli per ${curMonth}</div><div class="sb-title">Cosa fare in giardino</div><div class="sb-tips">${allTips.map(t=>`<div class="sb-tip"><div class="sb-tip-dot"></div><span>${t}</span></div>`).join('')}</div>`;}

const confettiCanvas=document.getElementById('confetti-canvas');
const ctx=confettiCanvas.getContext('2d');
let cp=[];
function resizeC(){confettiCanvas.width=window.innerWidth;confettiCanvas.height=window.innerHeight;}
resizeC();window.addEventListener('resize',resizeC);
function launchConfetti(){const cols=['#34C759','#007AFF','#FF9500','#FF3B30','#AF52DE'];for(let i=0;i<60;i++)cp.push({x:confettiCanvas.width/2,y:confettiCanvas.height*.4,vx:(Math.random()-.5)*8,vy:(Math.random()-1)*10,color:cols[Math.floor(Math.random()*cols.length)],size:Math.random()*6+3,rotation:Math.random()*360,rotSpeed:(Math.random()-.5)*10,opacity:1});animC();}
function animC(){if(!cp.length)return;ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);cp=cp.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.25;p.rotation+=p.rotSpeed;p.opacity-=.015;if(p.opacity<=0||p.y>confettiCanvas.height)return false;ctx.save();ctx.globalAlpha=p.opacity;ctx.fillStyle=p.color;ctx.translate(p.x,p.y);ctx.rotate(p.rotation*Math.PI/180);ctx.fillRect(-p.size/2,-p.size/4,p.size,p.size/2);ctx.restore();return true;});if(cp.length)requestAnimationFrame(animC);else ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);}

function openSearch(){document.getElementById('search-overlay').classList.add('open');document.getElementById('search-input').focus();}
function closeSearch(){document.getElementById('search-overlay').classList.remove('open');document.getElementById('search-input').value='';document.getElementById('search-results').innerHTML='<div class="search-empty">Inizia a digitare per cercare</div>';}
document.getElementById('search-input').addEventListener('input',function(){
  const q=this.value.trim().toLowerCase();
  if(!q){document.getElementById('search-results').innerHTML='<div class="search-empty">Inizia a digitare per cercare</div>';return;}
  const hl=txt=>txt.replace(new RegExp(q,'gi'),m=>`<span class="search-highlight">${m}</span>`);
  let html='';
  const pR=plants.filter(p=>(p.nome+p.sci+p.breve+p.fam+p.tipo).toLowerCase().includes(q));
  if(pR.length){html+=`<div class="search-section-header">ğŸŒ¸ Piante</div>`;html+=pR.slice(0,5).map(p=>`<div class="search-item" onclick="closeSearch();showPiantaDetail('${p.id}')"><div class="search-item-icon">${tipEmoji[p.tipo]||'ğŸŒ¿'}</div><div><div class="search-item-title">${hl(p.nome||'Pianta')}</div>${p.sci?`<div class="search-item-sub">${p.sci}</div>`:''}</div></div>`).join('');}
  const jR=journal.filter(j=>(j.att+(j.note||'')).toLowerCase().includes(q));
  if(jR.length){html+=`<div class="search-section-header">ğŸ“– Journal</div>`;html+=jR.slice(0,4).map(j=>`<div class="search-item" onclick="closeSearch();showJournalDetail('${j.id}')"><div class="search-item-icon">${actEmoji[j.att]||'ğŸ“'}</div><div><div class="search-item-title">${hl(j.att||'AttivitÃ ')}</div><div class="search-item-sub">${fmtDate(j.data)}</div></div></div>`).join('');}
  if(!html)html=`<div class="search-empty">Nessun risultato per "<strong>${q}</strong>"</div>`;
  document.getElementById('search-results').innerHTML=html;
});
document.getElementById('btn-search').addEventListener('click',openSearch);

const qActs=['Innaffiatura','Concimazione','Potatura','Trattamento','Osservazione','Rinvaso'];
const qEmoji=['ğŸ’§','ğŸ’Š','âœ‚ï¸','ğŸ§ª','ğŸ”','ğŸª´'];
function openQuickLog(pid,name){quickLogPid=pid;document.getElementById('ql-plant-name').textContent=name;document.getElementById('ql-grid').innerHTML=qActs.map((a,i)=>`<button class="ql-btn" onclick="doQuickLog('${a}')"><span style="font-size:24px">${qEmoji[i]}</span><span>${a}</span></button>`).join('');document.getElementById('quick-log').classList.add('open');}
function closeQuickLog(){document.getElementById('quick-log').classList.remove('open');}
async function doQuickLog(att){closeQuickLog();try{const obj={att,data:new Date().toISOString().split('T')[0],note:'',pid:quickLogPid||null,prid:null,user_id:currentUser.id};const saved=await dbInsert('journal',obj);journal.push(saved);renderJournal();toast(`âœ… ${att} registrata!`);setTimeout(()=>launchConfetti(),200);}catch(e){toast('âš ï¸ Errore: '+e.message);}}

function attachSwipeListeners(){document.querySelectorAll('.cal-card[data-swipeid]').forEach(card=>{let startX=0,dragging=false;card.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;dragging=true;},{passive:true});card.addEventListener('touchmove',e=>{if(!dragging)return;const dx=e.touches[0].clientX-startX;card.style.transform=`translateX(${Math.max(-80,Math.min(80,dx))}px)`;},{passive:true});card.addEventListener('touchend',async e=>{if(!dragging)return;const dx=e.changedTouches[0].clientX-startX;card.style.transform='';const id=card.dataset.swipeid;if(dx>60){const c=calendario.find(x=>x.id===id);if(c&&c.stato!=='done'){c.stato='done';await dbUpdate('calendario',id,{stato:'done'});launchConfetti();toast('ğŸ‰ Completato!');renderCalList();}}else if(dx<-60){if(confirm('Eliminare?')){await dbDelete('calendario',id);calendario=calendario.filter(x=>x.id!==id);renderCalList();toast('ğŸ—‘ï¸ Eliminato');}}dragging=false;},{passive:true});});}

// â•â•â• TABS â€” both sidebar and bottom bar â•â•â•
const tabTitles={piante:'Le mie piante',journal:'Garden Journal',knowledge:'Knowledge',prodotti:'Prodotti',calendario:'Calendario'};
function switchTab(tab){
  if(tab===curTab){document.getElementById('scroll-area').scrollTo({top:0,behavior:'smooth'});return;}
  document.querySelectorAll('.tab-item,.sidebar-item').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(`[data-tab="${tab}"]`).forEach(b=>b.classList.add('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById('sec-'+tab).classList.add('active');
  document.getElementById('nav-bar-title').textContent=tabTitles[tab];
  curTab=tab;
  document.getElementById('scroll-area').scrollTo({top:0,behavior:'instant'});
  renderAll();
}
document.querySelectorAll('.tab-item,.sidebar-item').forEach(btn=>{btn.addEventListener('click',()=>switchTab(btn.dataset.tab));});

document.getElementById('scroll-area').addEventListener('scroll',()=>{
  const y=document.getElementById('scroll-area').scrollTop;
  document.getElementById('nav-bar-title').classList.toggle('visible',y>80);
},{passive:true});

const fabActions={piante:()=>openPiantaSheet(),journal:()=>openJournalSheet(),knowledge:()=>openKnowledgeSheet(),prodotti:()=>openProdottoSheet(),calendario:()=>openCalSheet()};
document.getElementById('fab').addEventListener('click',()=>fabActions[curTab]?.());
document.getElementById('btn-add-quick').addEventListener('click',()=>fabActions[curTab]?.());
document.getElementById('btn-settings').addEventListener('click',()=>openSheet('sheet-settings'));
function openSheet(id){document.getElementById(id).classList.add('open');}
function closeSheet(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.sheet-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)closeSheet(o.id);}));
function openDetail(id){document.getElementById(id).classList.add('open');}
function closeDetail(id){document.getElementById(id).classList.remove('open');}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function fillPianteSelect(sel,sid=''){const el=document.getElementById(sel);const f=el.options[0].outerHTML;el.innerHTML=f+plants.map(p=>`<option value="${p.id}"${p.id===sid?' selected':''}>${p.nome}${p.sci?' ('+p.sci+')':''}</option>`).join('');}

function renderPiante(){
  generateSeasonalTips();
  if(plants.length>0){document.getElementById('piante-stats').style.display='grid';document.getElementById('stat-piante').textContent=plants.length;document.getElementById('stat-journal').textContent=journal.length;document.getElementById('stat-cal').textContent=calendario.length;document.getElementById('piante-subtitle').textContent=plants.length+(plants.length===1?' pianta nel tuo archivio':' piante nel tuo archivio');}else{document.getElementById('piante-stats').style.display='none';}
  const list=document.getElementById('piante-list');
  if(!plants.length){list.innerHTML=`<div class="empty"><div class="empty-icon">ğŸŒ±</div><div class="empty-title">Nessuna pianta</div><div class="empty-body">Tocca + per aggiungere la prima pianta</div></div>`;return;}
  // On iPad use grid wrapper
  const isWide=window.innerWidth>=768;
  if(isWide){
    list.style.display='grid';
    list.style.gridTemplateColumns='repeat(auto-fill,minmax(320px,1fr))';
    list.style.gap='12px';
    list.style.padding='0 20px 24px';
  } else {
    list.style.display='';list.style.gridTemplateColumns='';list.style.gap='';list.style.padding='';
  }
  list.innerHTML=plants.map(p=>{const score=calcHealthScore(p);return`<div class="plant-card" style="${isWide?'margin:0':''}" onclick="showPiantaDetail('${p.id}')"><div class="plant-card-top"><div class="plant-names"><div class="plant-name">${p.nome||'Pianta'}</div>${p.sci?`<div class="plant-sci">${p.sci}</div>`:''}</div><div class="plant-card-right">${p.tipo?`<span class="plant-type-pill">${tipEmoji[p.tipo]||'ğŸŒ¿'} ${p.tipo}</span>`:''}${renderHealthRing(score)}</div></div><div class="plant-meta">${chip('â˜€ï¸',p.esp)}${chip('ğŸŒ¸',p.fior)}${chip('ğŸ“',p.pos)}</div>${p.breve?`<div class="plant-desc">${p.breve}</div>`:''}<div class="plant-actions"><button class="icon-btn" onclick="event.stopPropagation();openQuickLog('${p.id}','${p.nome||'Pianta'}')">âš¡</button><button class="icon-btn" onclick="event.stopPropagation();openPiantaSheet('${p.id}')">âœï¸</button><button class="icon-btn" onclick="event.stopPropagation();delPianta('${p.id}')">ğŸ—‘ï¸</button></div></div>`;}).join('');
}

function showPiantaDetail(id){
  const p=plants.find(x=>x.id===id);if(!p)return;
  const score=calcHealthScore(p);
  document.getElementById('dpn-title').textContent=p.nome||'Pianta';
  document.getElementById('dpn-edit').onclick=()=>{closeDetail('detail-pianta');openPiantaSheet(id);};
  const relJ=journal.filter(j=>j.pid===id),relC=calendario.filter(c=>c.pid===id);
  document.getElementById('dpn-body').innerHTML=`<div class="detail-hero"><div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px"><div><div class="detail-hero-name">${p.nome||'Pianta'}</div>${p.sci?`<div class="detail-hero-sci">${p.sci}</div>`:''}</div><div style="flex-shrink:0">${renderHealthRing(score)}</div></div>${p.breve?`<div class="detail-hero-desc">${p.breve}</div>`:''}<div style="margin-top:12px;display:flex;gap:8px"><button onclick="openQuickLog('${id}','${p.nome||'Pianta'}')" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);color:white;padding:8px 14px;border-radius:20px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;">âš¡ Log rapido</button></div></div>${(p.tipo||p.esp||p.fior||p.alt||p.rust||p.fam)?`<div class="detail-section"><div class="detail-section-title">Informazioni</div><div class="info-grid">${infoCell('Tipologia',p.tipo)}${infoCell('Famiglia',p.fam)}${infoCell('Esposizione',p.esp)}${infoCell('Fioritura',p.fior)}${infoCell('Altezza',p.alt)}${infoCell('RusticitÃ ',p.rust)}</div></div>`:''}${(p.terr||p.inn||p.pot||p.con||p.prop)?`<div class="detail-section"><div class="detail-section-title">Coltivazione</div><div class="info-grid">${infoCell('Terreno',p.terr,true)}${infoCell('Innaffiatura',p.inn)}${infoCell('Potatura',p.pot)}${infoCell('Concimazione',p.con)}${infoCell('Propagazione',p.prop)}</div></div>`:''}${p.mal?`<div class="detail-section"><div class="detail-section-title">Malattie</div><div class="info-grid">${infoCell('',p.mal,true)}</div></div>`:''}${(p.pos||p.note)?`<div class="detail-section"><div class="detail-section-title">Note personali</div><div class="info-grid">${infoCell('Posizione',p.pos,true)}${infoCell('Note',p.note,true)}</div></div>`:''}${relJ.length?`<div class="detail-section"><div class="detail-section-title">AttivitÃ  (${relJ.length})</div><div class="detail-tags">${relJ.map(j=>`<span class="dtag green" onclick="showJournalDetail('${j.id}')" style="cursor:pointer">${actEmoji[j.att]||'ğŸ“–'} ${j.att} Â· ${fmtDate(j.data)}</span>`).join('')}</div></div>`:''}${relC.length?`<div class="detail-section"><div class="detail-section-title">Lavori pianificati (${relC.length})</div><div class="detail-tags">${relC.map(c=>`<span class="dtag" style="cursor:pointer">${c.att} Â· ${c.mese}</span>`).join('')}</div></div>`:''}<div style="height:40px"></div>`;
  openDetail('detail-pianta');
}

function openPiantaSheet(id=''){
  ['nome','sci','fam','tipo','breve','storia','esp','fior','nfior','alt','rust','terr','lav','pacc','inn','pot','con','prop','mal','note','pos','link','rhs'].forEach(f=>{const el=document.getElementById('p-'+f);if(el)el.value='';});
  document.getElementById('p-id').value='';document.getElementById('sheet-pianta-title').textContent=id?'Modifica pianta':'Nuova pianta';
  if(id){const p=plants.find(x=>x.id===id);if(!p)return;document.getElementById('p-id').value=id;['nome','sci','fam','tipo','breve','storia','esp','fior','nfior','alt','rust','terr','lav','pacc','inn','pot','con','prop','mal','note','pos','link','rhs'].forEach(f=>{const el=document.getElementById('p-'+f);if(el&&p[f])el.value=p[f];});}
  openSheet('sheet-pianta');
}
async function savePianta(){
  const nome=document.getElementById('p-nome').value.trim();if(!nome){toast('âš ï¸ Inserisci il nome');return;}
  const id=vs('p-id');
  const obj={nome,sci:vt('p-sci'),fam:vt('p-fam'),tipo:vs('p-tipo'),breve:vt('p-breve'),storia:vt('p-storia'),esp:vs('p-esp'),fior:vt('p-fior'),nfior:vt('p-nfior'),alt:vt('p-alt'),rust:vt('p-rust'),terr:vt('p-terr'),lav:vt('p-lav'),pacc:vt('p-pacc'),inn:vt('p-inn'),pot:vt('p-pot'),con:vt('p-con'),prop:vt('p-prop'),mal:vt('p-mal'),note:vt('p-note'),pos:vt('p-pos'),link:vt('p-link'),rhs:vt('p-rhs'),user_id:currentUser.id};
  try{if(id){const saved=await dbUpdate('piante',id,obj);const i=plants.findIndex(x=>x.id===id);plants[i]={...plants[i],...saved};}else{const saved=await dbInsert('piante',obj);plants.push(saved);}closeSheet('sheet-pianta');renderPiante();toast(id?'âœ… Pianta aggiornata':'ğŸŒ± Pianta aggiunta!');}catch(e){toast('âš ï¸ Errore: '+e.message);}
}
async function delPianta(id){if(!confirm('Eliminare questa pianta?'))return;try{await dbDelete('piante',id);plants=plants.filter(x=>x.id!==id);renderPiante();toast('Pianta eliminata');}catch(e){toast('âš ï¸ Errore: '+e.message);}}

function renderJournal(){
  document.getElementById('journal-subtitle').textContent=journal.length+(journal.length===1?' attivitÃ ':' attivitÃ ');
  const list=document.getElementById('journal-list');
  if(!journal.length){list.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-title">Nessuna attivitÃ </div><div class="empty-body">Usa âš¡ sulle piante per il log rapido!</div></div>`;return;}
  const isWide=window.innerWidth>=768;
  if(isWide){list.style.display='grid';list.style.gridTemplateColumns='repeat(auto-fill,minmax(300px,1fr))';list.style.gap='10px';list.style.padding='0 20px 24px';}
  else{list.style.display='';list.style.gridTemplateColumns='';list.style.gap='';list.style.padding='';}
  const sorted=[...journal].sort((a,b)=>new Date(b.data||0)-new Date(a.data||0));
  list.innerHTML=sorted.map(j=>`<div class="journal-card" style="${isWide?'margin:0':''}" onclick="showJournalDetail('${j.id}')"><div class="jc-top"><div style="display:flex;align-items:center;gap:8px"><div class="jc-icon">${actEmoji[j.att]||'ğŸ“'}</div><div><div class="jc-activity">${j.att||'AttivitÃ '}</div>${j.pid?`<div style="font-size:13px;color:var(--label3)">${pName(j.pid)}</div>`:''}</div></div><span class="jc-date">${fmtDate(j.data)}</span></div>${j.note?`<div class="plant-desc">${j.note}</div>`:''}<div class="plant-actions"><button class="icon-btn" onclick="event.stopPropagation();openJournalSheet('${j.id}')">âœï¸</button><button class="icon-btn" onclick="event.stopPropagation();delJournal('${j.id}')">ğŸ—‘ï¸</button></div></div>`).join('');
}
function showJournalDetail(id){const j=journal.find(x=>x.id===id);if(!j)return;document.getElementById('djn-edit').onclick=()=>{closeDetail('detail-journal');openJournalSheet(id);};document.getElementById('djn-body').innerHTML=`<div class="detail-hero"><div style="font-size:44px;margin-bottom:10px">${actEmoji[j.att]||'ğŸ“'}</div><div class="detail-hero-name">${j.att||'AttivitÃ '}</div><div style="color:rgba(255,255,255,.6);margin-top:6px;font-size:14px">${fmtDate(j.data)}</div></div><div class="detail-section"><div class="detail-section-title">Dettagli</div><div class="info-grid">${j.pid?infoCell('Pianta',pName(j.pid),true):''}${j.note?infoCell('Note',j.note,true):''}</div></div><div style="height:40px"></div>`;openDetail('detail-journal');}
function openJournalSheet(id=''){['att','note'].forEach(f=>document.getElementById('j-'+f).value='');document.getElementById('j-data').value=new Date().toISOString().split('T')[0];document.getElementById('j-id').value='';fillPianteSelect('j-pianta');if(id){const j=journal.find(x=>x.id===id);if(!j)return;document.getElementById('j-id').value=id;document.getElementById('j-att').value=j.att||'';document.getElementById('j-data').value=j.data||'';document.getElementById('j-note').value=j.note||'';fillPianteSelect('j-pianta',j.pid);}openSheet('sheet-journal');}
async function saveJournal(){if(!vs('j-att')){toast('âš ï¸ Scegli un\'attivitÃ ');return;}const id=vs('j-id');const obj={att:vs('j-att'),data:vs('j-data'),note:vt('j-note'),pid:vs('j-pianta')||null,prid:null,user_id:currentUser.id};try{if(id){const saved=await dbUpdate('journal',id,obj);const i=journal.findIndex(x=>x.id===id);journal[i]={...journal[i],...saved};}else{const saved=await dbInsert('journal',obj);journal.push(saved);}closeSheet('sheet-journal');renderJournal();toast(id?'âœ… Aggiornata':'ğŸ“– AttivitÃ  salvata!');}catch(e){toast('âš ï¸ Errore: '+e.message);}}
async function delJournal(id){if(!confirm('Eliminare?'))return;try{await dbDelete('journal',id);journal=journal.filter(x=>x.id!==id);renderJournal();}catch(e){toast('âš ï¸ Errore');}}

function renderKnowledge(){
  const list=document.getElementById('knowledge-list');
  if(!knowledge.length){list.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“°</div><div class="empty-title">Nessuna risorsa</div><div class="empty-body">Salva articoli e link botanici utili</div></div>`;return;}
  const isWide=window.innerWidth>=768;
  if(isWide){list.style.display='grid';list.style.gridTemplateColumns='repeat(auto-fill,minmax(280px,1fr))';list.style.gap='10px';list.style.padding='0 20px 24px';}
  else{list.style.display='';list.style.gridTemplateColumns='';list.style.gap='';list.style.padding='';}
  list.innerHTML=knowledge.map(k=>`<div class="k-card" style="${isWide?'margin:0':''}" onclick="showKnowDetail('${k.id}')">${k.topic?`<div class="k-topic">${k.topic}</div>`:''}<div class="k-title">${k.tit||'Risorsa'}</div>${k.src?`<div class="k-source">ğŸ“Œ ${k.src}</div>`:''}${k.pid?`<div style="margin-top:6px"><span style="font-size:12px;background:var(--green-soft);color:var(--green-dark);padding:3px 10px;border-radius:20px;font-weight:600">ğŸŒ¿ ${pName(k.pid)}</span></div>`:''}<div class="plant-actions"><button class="icon-btn" onclick="event.stopPropagation();openKnowledgeSheet('${k.id}')">âœï¸</button><button class="icon-btn" onclick="event.stopPropagation();delKnow('${k.id}')">ğŸ—‘ï¸</button></div></div>`).join('');
}
function showKnowDetail(id){const k=knowledge.find(x=>x.id===id);if(!k)return;document.getElementById('dkn-edit').onclick=()=>{closeDetail('detail-knowledge');openKnowledgeSheet(id);};document.getElementById('dkn-body').innerHTML=`<div class="detail-hero">${k.topic?`<div style="font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.4);margin-bottom:8px">${k.topic}</div>`:''}<div class="detail-hero-name">${k.tit||'Risorsa'}</div>${k.src?`<div class="detail-hero-sci">${k.src}</div>`:''}</div><div class="detail-section"><div class="detail-section-title">Contenuto</div><div class="info-grid">${k.note?infoCell('Note',k.note,true):''}${k.pid?infoCell('Pianta',pName(k.pid),true):''}${k.url?`<div class="info-cell full"><div class="info-cell-label">URL</div><a href="${k.url}" target="_blank" style="color:#007AFF;font-size:13px;word-break:break-all">${k.url}</a></div>`:''}</div></div><div style="height:40px"></div>`;openDetail('detail-knowledge');}
function openKnowledgeSheet(id=''){['tit','note','src','url'].forEach(f=>document.getElementById('k-'+f).value='');document.getElementById('k-topic').value='';document.getElementById('k-id').value='';fillPianteSelect('k-pianta');if(id){const k=knowledge.find(x=>x.id===id);if(!k)return;document.getElementById('k-id').value=id;document.getElementById('k-tit').value=k.tit||'';document.getElementById('k-note').value=k.note||'';document.getElementById('k-src').value=k.src||'';document.getElementById('k-topic').value=k.topic||'';document.getElementById('k-url').value=k.url||'';fillPianteSelect('k-pianta',k.pid);}openSheet('sheet-knowledge');}
async function saveKnowledge(){if(!vt('k-tit')){toast('âš ï¸ Inserisci un titolo');return;}const id=vs('k-id');const obj={tit:vt('k-tit'),note:vt('k-note'),src:vt('k-src'),topic:vs('k-topic'),url:vt('k-url'),pid:vs('k-pianta')||null,user_id:currentUser.id};try{if(id){const saved=await dbUpdate('knowledge',id,obj);const i=knowledge.findIndex(x=>x.id===id);knowledge[i]={...knowledge[i],...saved};}else{const saved=await dbInsert('knowledge',obj);knowledge.push(saved);}closeSheet('sheet-knowledge');renderKnowledge();toast(id?'âœ… Aggiornata':'ğŸ“š Risorsa salvata!');}catch(e){toast('âš ï¸ Errore: '+e.message);}}
async function delKnow(id){if(!confirm('Eliminare?'))return;try{await dbDelete('knowledge',id);knowledge=knowledge.filter(x=>x.id!==id);renderKnowledge();}catch(e){toast('âš ï¸ Errore');}}

function renderProdotti(){
  const list=document.getElementById('prodotti-list');
  if(!prodotti.length){list.innerHTML=`<div class="empty"><div class="empty-icon">ğŸŒ¿</div><div class="empty-title">Inventario vuoto</div><div class="empty-body">Aggiungi fertilizzanti e strumenti</div></div>`;return;}
  const groups={};prodotti.forEach(p=>{const c=p.cat||'Altro';if(!groups[c])groups[c]=[];groups[c].push(p);});
  list.innerHTML=Object.entries(groups).map(([cat,items])=>`<div class="section-block"><div class="section-block-header">${cat}</div><div class="list-card">${items.map(p=>`<div class="list-row"><div style="font-size:26px">${catEmoji[p.cat]||'ğŸ“¦'}</div><div style="flex:1;min-width:0"><div style="font-size:16px;font-weight:500;color:var(--label)">${p.nome}</div>${p.acq?`<div style="font-size:13px;color:var(--label3)">${fmtDate(p.acq)}</div>`:''}</div><div style="display:flex;gap:6px"><button class="icon-btn" onclick="openProdottoSheet('${p.id}')">âœï¸</button><button class="icon-btn" onclick="delProd('${p.id}')">ğŸ—‘ï¸</button></div></div>`).join('')}</div></div>`).join('');
}
function openProdottoSheet(id=''){['nome','note','url'].forEach(f=>document.getElementById('pr-'+f).value='');document.getElementById('pr-cat').value='';document.getElementById('pr-acq').value='';document.getElementById('pr-id').value='';if(id){const p=prodotti.find(x=>x.id===id);if(!p)return;document.getElementById('pr-id').value=id;document.getElementById('pr-nome').value=p.nome||'';document.getElementById('pr-cat').value=p.cat||'';document.getElementById('pr-acq').value=p.acq||'';document.getElementById('pr-note').value=p.note||'';document.getElementById('pr-url').value=p.url||'';}openSheet('sheet-prodotto');}
async function saveProdotto(){if(!vt('pr-nome')){toast('âš ï¸ Inserisci il nome');return;}const id=vs('pr-id');const obj={nome:vt('pr-nome'),cat:vs('pr-cat'),acq:vs('pr-acq')||null,note:vt('pr-note'),url:vt('pr-url'),user_id:currentUser.id};try{if(id){const saved=await dbUpdate('prodotti',id,obj);const i=prodotti.findIndex(x=>x.id===id);prodotti[i]={...prodotti[i],...saved};}else{const saved=await dbInsert('prodotti',obj);prodotti.push(saved);}closeSheet('sheet-prodotto');renderProdotti();toast(id?'âœ… Aggiornato':'ğŸ§´ Prodotto aggiunto!');}catch(e){toast('âš ï¸ Errore: '+e.message);}}
async function delProd(id){if(!confirm('Eliminare?'))return;try{await dbDelete('prodotti',id);prodotti=prodotti.filter(x=>x.id!==id);renderProdotti();}catch(e){toast('âš ï¸ Errore');}}

function renderCalMonths(){document.getElementById('month-strip').innerHTML=MESI.map(m=>`<button class="month-pill${m===curMonth?' active':''}" onclick="selMonth('${m}')">${m.slice(0,3)}</button>`).join('');}
function selMonth(m){curMonth=m;document.querySelectorAll('.month-pill').forEach(b=>b.classList.toggle('active',b.textContent===m.slice(0,3)));renderCalList();}
function renderCalList(){
  const list=document.getElementById('calendario-list');
  let items=calendario.filter(c=>c.mese===curMonth);
  if(curStatusFilter!=='all')items=items.filter(c=>c.stato===curStatusFilter);
  if(!items.length){list.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ—“ï¸</div><div class="empty-title">Nessun lavoro</div><div class="empty-body">Pianifica attivitÃ  per ${curMonth}</div></div>`;return;}
  list.innerHTML=items.map(c=>{const sm=statusMeta[c.stato]||statusMeta.todo;return`<div class="cal-card-wrap"><div class="cal-card-swipe-bg"><span class="swipe-icon">âœ“</span></div><div class="cal-card-swipe-bg red-bg"><span class="swipe-icon">ğŸ—‘</span></div><div class="cal-card" data-swipeid="${c.id}" onclick="cycleCalStatus('${c.id}')"><div class="cal-status ${sm.cls}"></div><div class="cal-body"><div class="cal-title">${c.att||'Lavoro'}</div>${c.pid?`<div style="font-size:12px;color:var(--label3);margin-top:2px">ğŸŒ¿ ${pName(c.pid)}</div>`:''}${c.note?`<div class="cal-note">${c.note}</div>`:''}<div style="margin-top:5px;font-size:11px;font-weight:600;color:var(--label3)">${sm.lbl}</div></div><div style="display:flex;gap:6px;flex-shrink:0"><button class="icon-btn" onclick="event.stopPropagation();openCalSheet('${c.id}')">âœï¸</button><button class="icon-btn" onclick="event.stopPropagation();delCal('${c.id}')">ğŸ—‘ï¸</button></div></div></div>`;}).join('');
  attachSwipeListeners();
}
document.getElementById('status-seg').addEventListener('click',e=>{const btn=e.target.closest('.seg-btn');if(!btn)return;document.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');curStatusFilter=btn.dataset.s;renderCalList();});
async function cycleCalStatus(id){const c=calendario.find(x=>x.id===id);if(!c)return;const order=['todo','doing','done','skip'];const prev=c.stato;c.stato=order[(order.indexOf(c.stato)+1)%order.length];try{await dbUpdate('calendario',id,{stato:c.stato});renderCalList();if(c.stato==='done'&&prev!=='done'){launchConfetti();toast('ğŸ‰ Completato!');}else toast('â†’ '+statusMeta[c.stato].lbl);}catch(e){toast('âš ï¸ Errore');}}
function openCalSheet(id=''){['att','note'].forEach(f=>document.getElementById('c-'+f).value='');document.getElementById('c-mese').value=curMonth;document.getElementById('c-stato').value='todo';document.getElementById('c-id').value='';fillPianteSelect('c-pianta');if(id){const c=calendario.find(x=>x.id===id);if(!c)return;document.getElementById('c-id').value=id;document.getElementById('c-att').value=c.att||'';document.getElementById('c-mese').value=c.mese||'';document.getElementById('c-stato').value=c.stato||'todo';document.getElementById('c-note').value=c.note||'';fillPianteSelect('c-pianta',c.pid);}openSheet('sheet-cal');}
async function saveCal(){if(!vs('c-att')||!vs('c-mese')){toast('âš ï¸ Scegli attivitÃ  e mese');return;}const id=vs('c-id');const obj={att:vs('c-att'),mese:vs('c-mese'),stato:vs('c-stato'),note:vt('c-note'),pid:vs('c-pianta')||null,user_id:currentUser.id};try{if(id){const saved=await dbUpdate('calendario',id,obj);const i=calendario.findIndex(x=>x.id===id);calendario[i]={...calendario[i],...saved};}else{const saved=await dbInsert('calendario',obj);calendario.push(saved);}closeSheet('sheet-cal');renderCalendario();toast(id?'âœ… Aggiornato':'ğŸ“… Lavoro pianificato!');}catch(e){toast('âš ï¸ Errore: '+e.message);}}
async function delCal(id){if(!confirm('Eliminare?'))return;try{await dbDelete('calendario',id);calendario=calendario.filter(x=>x.id!==id);renderCalList();}catch(e){toast('âš ï¸ Errore');}}
function renderCalendario(){renderCalMonths();renderCalList();}
function renderAll(){renderPiante();renderJournal();renderKnowledge();renderProdotti();renderCalendario();}
window.addEventListener('resize',()=>renderAll());

const mf={name:'Garden',short_name:'Garden',start_url:'./',display:'standalone',background_color:'#F2F2F7',theme_color:'#34C759',orientation:'portrait',icons:[{src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='44' fill='%2334C759'/%3E%3Ctext y='140' x='28' font-size='128'%3EğŸŒ¿%3C/text%3E%3C/svg%3E",sizes:'192x192',type:'image/svg+xml',purpose:'any maskable'}]};
document.getElementById('manifest-link').href=URL.createObjectURL(new Blob([JSON.stringify(mf)],{type:'application/json'}));

// â•â•â• PERSISTENT LOGIN â•â•â•
function saveSession(token,user,email){try{localStorage.setItem('garden_token',token);localStorage.setItem('garden_user',JSON.stringify(user));localStorage.setItem('garden_email',email);}catch(e){}}
function clearSession(){try{localStorage.removeItem('garden_token');localStorage.removeItem('garden_user');localStorage.removeItem('garden_email');}catch(e){}}
function loadSession(){try{const token=localStorage.getItem('garden_token');const user=JSON.parse(localStorage.getItem('garden_user')||'null');const email=localStorage.getItem('garden_email')||'';return token&&user?{token,user,email}:null;}catch(e){return null;}}

window.addEventListener('DOMContentLoaded',()=>{
  setTimeout(()=>{
    document.getElementById('splash').classList.add('out');
    setTimeout(async()=>{
      document.getElementById('splash').remove();
      const session=loadSession();
      if(session){
        authToken=session.token;currentUser=session.user;
        document.getElementById('settings-email').textContent=session.email;
        document.getElementById('sidebar-email-label').textContent=session.email;
        await showApp();
      }else{
        document.getElementById('auth-screen').style.display='flex';
      }
    },500);
  },1200);
});
document.getElementById('auth-pass').addEventListener('keydown',e=>{if(e.key==='Enter')authSubmit();});
</script>

</body>
</html>
